name: Update OpenAPI from API2Cart

on:
  schedule:
    - cron: '0 0 * * *'     # Автоматичний запуск щодня опівночі (UTC)
  workflow_dispatch:         # Дозволяє вручну запускати у вкладці Actions

permissions:
  contents: write            # Дає дозвіл на пуш у репозиторій

jobs:
  update-openapi:
    runs-on: ubuntu-latest

    steps:
      # Крок 1: Клонувати (checkout) цей репозиторій у робочу директорію Action
      - name: Check out repository
        uses: actions/checkout@v2

      # Крок 2: Завантажити файли openapi.json (загальний та мовні) у відповідні папки
      - name: Fetch OpenAPI files
        run: |
          # Створюємо підпапки (якщо вони не існують)
          mkdir -p de es it fr
          
          # Завантажуємо основний openapi.json
          curl -fSLo openapi.json https://app.api2cart.com/openapi/openapi.json

          # Завантажуємо мовні openapi-файли
          curl -fSLo de/de_openapi.json https://app.api2cart.com/openapi/de_openapi.json
          curl -fSLo es/es_openapi.json https://app.api2cart.com/openapi/es_openapi.json
          curl -fSLo it/it_openapi.json https://app.api2cart.com/openapi/it_openapi.json
          curl -fSLo fr/fr_openapi.json https://app.api2cart.com/openapi/fr_openapi.json

      # Крок 3: Закомітити файли, якщо вони змінилися
      - name: Commit changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add openapi.json de/ es/ it/ fr/
            git commit -m "Update openapi files automatically"
          else
            echo "No changes in openapi.json. Skip commit."
          fi

      # Крок 4: Запушити зміни назад у GitHub
      - name: Push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          branch: main
          github_token: ${{ secrets.GITHUB_TOKEN }}
